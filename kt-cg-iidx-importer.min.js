!function(){"use strict";(()=>{const e="api-key",t="#e61c6e",n="-".repeat(40),o={B:"BEGINNER",N:"NORMAL",H:"HYPER",A:"ANOTHER",L:"LEGGENDARIA"};function r(){let e="kt-cg-iidx-importer";const t=window.location.href;return t.includes("dev")?e+=" (Dev)":t.includes("ganymede")?e+=" (GAN)":t.includes("nageki")&&(e+=" (NAG)"),e}function i(e){const t=document.getElementById("log-box"),n=(new Date).toTimeString().slice(0,8);t.innerHTML+=`[${n}] ${e}\n`;try{t.scrollTop=t.scrollHeight}catch(e){}}function c(e){return localStorage.getItem(`__ktimporter__${e}`)}function a(e){return new Promise(t=>setTimeout(t,e))}function s(){const e=function(){const e=document.querySelector(".score-grid").nextElementSibling,t={currentPage:1,totalPages:1};return e&&(t.currentPage=parseInt(e.innerText.split(" ")[1]),t.totalPages=parseInt(e.innerText.split(" ")[3])),t}(),t=[];for(let n=e.currentPage;n<=e.totalPages&&10!=t.length;n++)t.push(n);return t}function l(e){const t={SP:[],DP:[]};return e.querySelector(".score-grid").querySelectorAll(":scope > .grid-x").forEach(e=>{const n=e.querySelectorAll(":scope > .cell"),r={gameVerButThisShouldNotBeInTheFinalJson:n[0].querySelector("a").href.split("/")[5],matchType:"inGameID"},i=o[n[0].querySelectorAll("strong")[1].textContent.trim().slice(-1)];if("BEGINNER"==i)return;r.identifier=n[0].querySelector("a").href.split("/")[6],r.difficulty=i,r.lamp=n[0].querySelector(".label").textContent.trim(),r.score=+n[2].querySelector("strong").textContent.trim().split(" ")[0].replace(",",""),r.timeAchieved=function(e){const t=(e=e.replace("UTC","").trim()).match(/^\s*(\d{1,2})(?:st|nd|rd|th)?\s+([A-Za-z]{3})(?:\s+(\d{4}))?,\s*(\d{1,2}):(\d{2})\s*$/);if(!t){const t=Date.parse(e);return isNaN(t)?-1:t}const n=parseInt(t[1],10),o=t[2].slice(0,1).toUpperCase()+t[2].slice(1).toLowerCase(),r=t[3]?parseInt(t[3],10):(new Date).getFullYear(),i=parseInt(t[4],10),c=parseInt(t[5],10),a={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[o];return void 0===a?-1:Date.UTC(r,a,n,i,c)}(n[2].querySelectorAll(".cell")[1].textContent.trim()),r.judgements={pgreat:+n[2].querySelector("strong").title.split(",")[0].trim().split(" ")[0],great:+n[2].querySelector("strong").title.split(",")[1].trim().split(" ")[0]};const c=n[2].querySelector("strong").title.split(",")[2].trim().split(" ")[0];"-"!=c&&(r.optional={bp:+c});"SP"==n[0].querySelectorAll("strong")[1].textContent.trim().slice(0,2)?t.SP.push(r):t.DP.push(r)}),t}async function d(t,n,o){const r=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${c(e)}`}}),a=await r.json(),s=`[Import for IIDX ${n} ${o}] `;if(a.success)if("ongoing"!==a.body.importStatus){if("completed"===a.body.importStatus){console.log(a.body);let e=s+a.description+` ${a.body.import.scoreIDs.length} new scores`,t="";if(a.body.import.errors.length>0){t=" (see console log for details)";for(const e of a.body.import.errors)console.log(`${e.type}: ${e.message}`)}return e+=`, ${a.body.import.errors.length} errors${t}.`,void i(e)}i(a.description)}else setTimeout(d,1e3,t,n,o);else i(s+"Error: "+a.description)}async function u(t,n,o){const r=fetch("https://kamai.tachi.ac/ir/direct-manual/import",{method:"POST",headers:{Authorization:"Bearer "+c(e),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(t)}),i=(await(await r).json()).body.url;await d(i,n,o)}async function p(e){i(n);const t=function(e){const t={};for(const n of Object.keys(e))for(const o of e[n]){const{gameVerButThisShouldNotBeInTheFinalJson:e,...r}=o,i=e;t[i]||(t[i]={SP:[],DP:[]}),t[i][n].push(r)}return t}(await async function(){const e=s(),t=new DOMParser,n={SP:[],DP:[]},o=e.at(0),r=e.at(-1);i(`Fetching all scores from pages ${o} to ${r}...`);for(let e=o;e<=r;e++){const o=document.URL.split("?")[0]+`?page=${e}`,r=await fetch(o),c=l(t.parseFromString(await r.text(),"text/html"));n.SP=n.SP.concat(c.SP),n.DP=n.DP.concat(c.DP),i(`Fetched all scores from ${o}`),await a(250)}return n}()),o=function(e){let t=0;for(const n in e){const o=e[n];o.SP.length>0&&t++,o.DP.length>0&&t++}return t}(t);i(`Starting imports for each game version and playtype (${o} import(s))...`),i(n);for(const n in t){const o=t[n],i={meta:{game:"iidx",playtype:"SP",service:r(),version:n+""+(e?"-omni":"")},scores:o.SP};o.SP.length>0&&await u(i,n+""+(e?" Omnimix":""),"SP"),o.DP.length>0&&(i.meta.playtype="DP",i.scores=o.DP,await u(i,n+""+(e?" Omnimix":""),"DP"))}}function m(n){const o=document.createElement("div");o.id="ktimporter-overlay",Object.assign(o.style,{position:"fixed",inset:"0",backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999});const r=document.createElement("div");Object.assign(r.style,{background:"#1e1e1e",color:"#eee",padding:"1rem",borderRadius:"6px",minWidth:"320px",maxWidth:"90%",boxShadow:"0 6px 24px rgba(0,0,0,0.6)"});const c=document.createElement("div");c.textContent="Enter API key",c.style.fontWeight="600",c.style.marginBottom="0.5rem";const a=document.createElement("input");a.type="text",a.value=n||"",a.placeholder="API key",Object.assign(a.style,{width:"100%",padding:"0.5rem",marginBottom:"0.75rem",boxSizing:"border-box",background:"#222",color:"#fff",border:"1px solid #333",borderRadius:"4px",outline:"none"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"});const l=document.createElement("button");l.type="button",l.textContent="Cancel",l.style.marginRight="0.5rem",Object.assign(l.style,{background:"transparent",color:"#ddd",border:"1px solid rgba(255,255,255,0.06)",padding:"0.4rem 0.6rem",borderRadius:"4px",cursor:"pointer"});const d=document.createElement("button");d.type="button",d.textContent="Get API key",d.style.marginRight="0.5rem",Object.assign(d.style,{background:"transparent",color:"#ddd",border:"1px solid rgba(255,255,255,0.06)",padding:"0.4rem 0.6rem",borderRadius:"4px",cursor:"pointer"});const u=document.createElement("button");u.type="button",u.textContent="OK",Object.assign(u.style,{background:t,color:"#fff",border:"none",padding:"0.45rem 0.8rem",borderRadius:"4px",cursor:"pointer"});const p=document.createElement("div");p.appendChild(d);const m=document.createElement("div");m.appendChild(l),m.appendChild(u),s.appendChild(p),s.appendChild(m),r.appendChild(c),r.appendChild(a),r.appendChild(s),o.appendChild(r),document.body.appendChild(o),setTimeout(()=>a.focus(),10);const g=document.body.style.overflow||"",y=document.documentElement.style.overflow||"",b=document.body.style.paddingRight||"",f=window.innerWidth-document.documentElement.clientWidth;f>0&&(document.body.style.paddingRight=`${f}px`),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden";let h=!1;function x(e){h=r.contains(e.target)}function k(){document.body.style.overflow=g,document.documentElement.style.overflow=y,document.body.style.paddingRight=b,o&&o.parentNode&&o.parentNode.removeChild(o),document.removeEventListener("mousedown",x,!0)}document.addEventListener("mousedown",x,!0),l.addEventListener("click",()=>{k()}),d.addEventListener("click",()=>{window.open("https://kamai.tachi.ac/client-file-flow/CIb4851b4fd80234cacb9934c1c0eee1c9d9da3030","_blank","noopener")}),o.addEventListener("click",e=>{e.target===o&&(h?h=!1:k())}),u.addEventListener("click",async()=>{const t=a.value.trim();if(!t)return void a.focus();k(),i("Verifying API key...");var n,o;await async function(e){return!!(await fetch("https://kamai.tachi.ac/api/v1/users/me",{headers:{Authorization:`Bearer ${e}`}}).then(e=>e.json())).success}(t)?(n=e,o=t,localStorage.setItem(`__ktimporter__${n}`,o.toString()),i("API key verified and saved. Reloading page to apply changes..."),setTimeout(()=>location.reload(),150)):i("Error: Failed to verify API key.")}),a.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),u.click())})}!function(){if(!document.getElementById("ktimporter-scroll-style")){const e=document.createElement("style");e.id="ktimporter-scroll-style",e.textContent="\n        /* WebKit-based browsers */\n        #log-box::-webkit-scrollbar { width: 10px; height: 10px; }\n        #log-box::-webkit-scrollbar-track { background: transparent; }\n        #log-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 6px; }\n        #log-box::-webkit-scrollbar-button { display: none; height: 0; }\n\n        /* Firefox */\n        #log-box { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.12) transparent; }\n      ",document.head.appendChild(e)}const e=document.createElement("td");e.setAttribute("colspan",2);const t=document.createElement("div");t.id="log-box",Object.assign(t.style,{whiteSpace:"pre",height:"200px",overflow:"auto",padding:"0.25rem",background:"transparent"}),e.appendChild(t);const n=document.createElement("tr");n.append(e),document.querySelector("form .panel tfoot tr").after(n)}(),i("Userscript ready! Logs will appear here."),function(){const n=document.querySelector("form .panel tfoot tr").querySelector('input[value="Update"]'),o=n.cloneNode();o.setAttribute("type","button"),o.id="api-key-button",o.style.backgroundColor=t,o.style.margin="0 0.75em";const r=!!c(e);o.value=r?"Reconfigure API key (if broken)":"Set API key",n.after(o),o.onclick=()=>{m(c(e)||"")}}(),function(){const t=document.getElementById("api-key-button");if(!t)return void console.error("Error: createImportButton() was called before the API key button was created");const n=t.cloneNode();n.style.margin="0",n.setAttribute("type","button"),n.id="import-button";const o=s();n.value=`Import pages ${o.at(0)}-${o.at(-1)}`,t.after(n);const r=document.createElement("label");r.style.marginLeft="0.75em",r.style.display="inline-flex",r.style.alignItems="center",r.style.gap="0.25em",r.style.verticalAlign="middle";const i=document.createElement("input");i.type="checkbox",i.id="omnimix-checkbox",i.style.margin="0",i.style.verticalAlign="middle";const a=document.createTextNode("Omnimix mode");r.appendChild(i),r.appendChild(a),n.after(r),n.onclick=async()=>{i.checked?await p(!0):await p(!1)},!!c(e)||(n.disabled=!0)}()})()}();
